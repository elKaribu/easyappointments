/* ----------------------------------------------------------------------------
 * Easy!Appointments - Open Source Web Scheduler
 *
 * @package     EasyAppointments
 * @author      A.Tselegidis <alextselegidis@gmail.com>
 * @copyright   Copyright (c) 2013 - 2020, Alex Tselegidis
 * @license     http://opensource.org/licenses/GPL-3.0 - GPLv3
 * @link        http://easyappointments.org
 * @since       v1.2.0
 * ---------------------------------------------------------------------------- */
window.BackendCalendarAppointmentsModal=window.BackendCalendarAppointmentsModal||{},function(e){"use strict";function a(){$("#manage-appointment #save-appointment").on("click",(function(){if(function(){var e=$("#manage-appointment");e.find(".has-error").removeClass("has-error"),e.find(".modal-message").addClass("d-none");try{var a=!1;if(e.find(".required").each((function(e,t){""!==$(t).val()&&null!==$(t).val()||($(t).closest(".form-group").addClass("has-error"),a=!0)})),a)throw new Error(EALang.fields_are_required);if(!GeneralFunctions.validateEmail(e.find("#email").val()))throw e.find("#email").closest(".form-group").addClass("has-error"),new Error(EALang.invalid_email);if($("#start-datetime").datetimepicker("getDate")>$("#end-datetime").datetimepicker("getDate"))throw e.find("#start-datetime, #end-datetime").closest(".form-group").addClass("has-error"),new Error(EALang.start_date_before_end_error);return!0}catch(a){return e.find(".modal-message").addClass("alert-danger").text(a.message).removeClass("d-none"),!1}}()){var e=$("#manage-appointment"),a=e.find("#start-datetime").datetimepicker("getDate").toString("yyyy-MM-dd HH:mm:ss"),t=e.find("#end-datetime").datetimepicker("getDate").toString("yyyy-MM-dd HH:mm:ss"),n={id_services:e.find("#select-service").val(),id_users_provider:e.find("#select-provider").val(),start_datetime:a,end_datetime:t,location:e.find("#appointment-location").val(),notes:e.find("#appointment-notes").val(),is_unavailable:!1};""!==e.find("#appointment-id").val()&&(n.id=e.find("#appointment-id").val());var i={first_name:e.find("#first-name").val(),last_name:e.find("#last-name").val(),email:e.find("#email").val(),phone_number:e.find("#phone-number").val(),address:e.find("#address").val(),city:e.find("#city").val(),zip_code:e.find("#zip-code").val(),notes:e.find("#customer-notes").val(),timezone:"Europe/Madrid",language:"catalan"};""!==e.find("#customer-id").val()&&(i.id=e.find("#customer-id").val(),n.id_users_customer=i.id);BackendCalendarApi.saveAppointment(n,i,(function(a){Backend.displayNotification(EALang.appointment_saved),e.find(".alert").addClass("d-none"),e.modal("hide"),$("#select-filter-item").trigger("change")}),(function(){e.find(".modal-message").text(EALang.service_communication_error),e.find(".modal-message").addClass("alert-danger").removeClass("d-none"),e.find(".modal-body").scrollTop(0)}))}})),$("#insert-appointment").on("click",(function(){$(".popover").remove(),BackendCalendarAppointmentsModal.resetAppointmentDialog();var e=$("#manage-appointment");if("provider"===$("#select-filter-item option:selected").attr("type")){var a=$("#select-filter-item").val(),t=GlobalVariables.availableProviders.filter((function(e){return Number(e.id)===Number(a)}));t.length&&(e.find("#select-service").val(t[0].services[0]).trigger("change"),e.find("#select-provider").val(a))}else"service"===$("#select-filter-item option:selected").attr("type")?e.find('#select-service option[value="'+$("#select-filter-item").val()+'"]').prop("selected",!0):e.find("#select-service option:first").prop("selected",!0).trigger("change");var n=e.find("#select-service").val(),i=GlobalVariables.availableServices.find((function(e){return Number(e.id)===Number(n)})),r=i?i.duration:60,s=new Date,d=parseInt(s.toString("mm"));d>0&&d<15?s.set({minute:15}):d>15&&d<30?s.set({minute:30}):d>30&&d<45?s.set({minute:45}):s.addHours(1).set({minute:0}),e.find("#start-datetime").val(GeneralFunctions.formatDate(s,GlobalVariables.dateFormat,!0)),e.find("#end-datetime").val(GeneralFunctions.formatDate(s.addMinutes(r),GlobalVariables.dateFormat,!0)),e.find(".modal-header h3").text(EALang.new_appointment_title),e.modal("show")})),$("#select-customer").on("click",(function(){var e=$("#existing-customers-list");e.is(":visible")?(e.slideUp("slow"),$("#filter-existing-customers").fadeOut("slow"),$(this).find("span").text(EALang.select)):($(this).find("span").text(EALang.hide),e.empty(),e.slideDown("slow"),$("#filter-existing-customers").fadeIn("slow"),$("#filter-existing-customers").val(""),GlobalVariables.customers.forEach((function(a){$("<div/>",{"data-id":a.id,text:a.first_name+" "+a.last_name}).appendTo(e)})))})),$("#manage-appointment").on("click","#existing-customers-list div",(function(){var e=$(this).attr("data-id"),a=GlobalVariables.customers.find((function(a){return Number(a.id)===Number(e)}));a&&($("#customer-id").val(a.id),$("#first-name").val(a.first_name),$("#last-name").val(a.last_name),$("#email").val(a.email),$("#phone-number").val(a.phone_number),$("#address").val(a.address),$("#city").val(a.city),$("#zip-code").val(a.zip_code),$("#customer-notes").val(a.notes)),$("#select-customer").trigger("click")}));var e=null;$("#filter-existing-customers").on("keyup",(function(){e&&clearTimeout(e);var a=$(this).val().toLowerCase();e=setTimeout((function(){var e=$("#existing-customers-list"),t=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_filter_customers",n={csrfToken:GlobalVariables.csrfToken,key:a};$("#loading").css("visibility","hidden"),$.post(t,n).done((function(a){e.empty(),a.forEach((function(a){$("<div/>",{"data-id":a.id,text:a.first_name+" "+a.last_name}).appendTo(e),GlobalVariables.customers.filter((function(e){return Number(e.id)===Number(a.id)})).length||GlobalVariables.customers.push(a)}))})).fail((function(t,n,i){e.empty(),GlobalVariables.customers.forEach((function(t,n){-1===t.first_name.toLowerCase().indexOf(a)&&-1===t.last_name.toLowerCase().indexOf(a)&&-1===t.email.toLowerCase().indexOf(a)&&-1===t.phone_number.toLowerCase().indexOf(a)&&-1===t.address.toLowerCase().indexOf(a)&&-1===t.city.toLowerCase().indexOf(a)&&-1===t.zip_code.toLowerCase().indexOf(a)&&-1===t.notes.toLowerCase().indexOf(a)||$("<div/>",{"data-id":t.id,text:t.first_name+" "+t.last_name}).appendTo(e)}))})).always((function(){$("#loading").css("visibility","")}))}),1e3)})),$("#select-service").on("change",(function(){var e=$("#select-service").val();$("#select-provider").empty();var a=GlobalVariables.availableServices.find((function(a){return Number(a.id)===Number(e)})),t=a?a.duration:60,n=$("#start-datetime").datetimepicker("getDate");$("#end-datetime").datetimepicker("setDate",new Date(n.getTime()+6e4*t)),GlobalVariables.availableProviders.forEach((function(a){a.services.forEach((function(t){GlobalVariables.user.role_slug===Backend.DB_SLUG_PROVIDER&&Number(a.id)!==GlobalVariables.user.id||GlobalVariables.user.role_slug===Backend.DB_SLUG_SECRETARY&&-1===GlobalVariables.secretaryProviders.indexOf(a.id)||Number(t)===Number(e)&&$("#select-provider").append(new Option(a.first_name+" "+a.last_name,a.id))}))}))})),$("#select-provider").on("change",(function(){var e,a;e=$("#select-provider").val(),(a=GlobalVariables.availableProviders.find((function(a){return Number(a.id)===Number(e)})))&&a.timezone&&$(".provider-timezone").text(GlobalVariables.timezones[a.timezone])})),$("#new-customer").on("click",(function(){$("#manage-appointment").find("#customer-id, #first-name, #last-name, #email, #phone-number, #address, #city, #zip-code, #customer-notes").val("")}))}e.resetAppointmentDialog=function(){var e=$("#manage-appointment");e.find("input, textarea").val(""),e.find(".modal-message").fadeOut(),e.find("#select-service").val(e.find("#select-service").eq(0).attr("value")),e.find("#select-provider").empty(),GlobalVariables.availableProviders.forEach((function(a,t){var n=e.find("#select-service").val();a.services.filter((function(e){return Number(e)===Number(n)})).length>0&&e.find("#select-provider").append(new Option(a.first_name+" "+a.last_name,a.id))})),$("#existing-customers-list").slideUp("slow"),$("#filter-existing-customers").fadeOut("slow"),$("#select-customer span").text(EALang.select);var a,t=e.find("#select-service").val(),n=GlobalVariables.availableServices.forEach((function(e){return Number(e.id)===Number(t)})),i=n?n.duration:0,r=new Date,s=(new Date).addMinutes(i);switch(GlobalVariables.dateFormat){case"DMY":a="dd/mm/yy";break;case"MDY":a="mm/dd/yy";break;case"YMD":a="yy/mm/dd";break;default:throw new Error("Invalid GlobalVariables.dateFormat value.")}var d=GlobalVariables.firstWeekday,o=GeneralFunctions.getWeekDayId(d);e.find("#start-datetime").datetimepicker({dateFormat:a,timeFormat:"regular"===GlobalVariables.timeFormat?"h:mm TT":"HH:mm",dayNames:[EALang.sunday,EALang.monday,EALang.tuesday,EALang.wednesday,EALang.thursday,EALang.friday,EALang.saturday],dayNamesShort:[EALang.sunday.substr(0,3),EALang.monday.substr(0,3),EALang.tuesday.substr(0,3),EALang.wednesday.substr(0,3),EALang.thursday.substr(0,3),EALang.friday.substr(0,3),EALang.saturday.substr(0,3)],dayNamesMin:[EALang.sunday.substr(0,2),EALang.monday.substr(0,2),EALang.tuesday.substr(0,2),EALang.wednesday.substr(0,2),EALang.thursday.substr(0,2),EALang.friday.substr(0,2),EALang.saturday.substr(0,2)],monthNames:[EALang.january,EALang.february,EALang.march,EALang.april,EALang.may,EALang.june,EALang.july,EALang.august,EALang.september,EALang.october,EALang.november,EALang.december],prevText:EALang.previous,nextText:EALang.next,currentText:EALang.now,closeText:EALang.close,timeOnlyTitle:EALang.select_time,timeText:EALang.time,hourText:EALang.hour,minuteText:EALang.minutes,firstDay:o,onClose:function(){var e=$("#select-service").val(),a=GlobalVariables.availableServices.find((function(a){return Number(a.id)===Number(e)})),t=$("#start-datetime").datetimepicker("getDate");$("#end-datetime").datetimepicker("setDate",new Date(t.getTime()+6e4*a.duration))}}),e.find("#start-datetime").datetimepicker("setDate",r),e.find("#end-datetime").datetimepicker({dateFormat:a,timeFormat:"regular"===GlobalVariables.timeFormat?"h:mm TT":"HH:mm",dayNames:[EALang.sunday,EALang.monday,EALang.tuesday,EALang.wednesday,EALang.thursday,EALang.friday,EALang.saturday],dayNamesShort:[EALang.sunday.substr(0,3),EALang.monday.substr(0,3),EALang.tuesday.substr(0,3),EALang.wednesday.substr(0,3),EALang.thursday.substr(0,3),EALang.friday.substr(0,3),EALang.saturday.substr(0,3)],dayNamesMin:[EALang.sunday.substr(0,2),EALang.monday.substr(0,2),EALang.tuesday.substr(0,2),EALang.wednesday.substr(0,2),EALang.thursday.substr(0,2),EALang.friday.substr(0,2),EALang.saturday.substr(0,2)],monthNames:[EALang.january,EALang.february,EALang.march,EALang.april,EALang.may,EALang.june,EALang.july,EALang.august,EALang.september,EALang.october,EALang.november,EALang.december],prevText:EALang.previous,nextText:EALang.next,currentText:EALang.now,closeText:EALang.close,timeOnlyTitle:EALang.select_time,timeText:EALang.time,hourText:EALang.hour,minuteText:EALang.minutes,firstDay:o}),e.find("#end-datetime").datetimepicker("setDate",s)},e.initialize=function(){a()}}(window.BackendCalendarAppointmentsModal);
