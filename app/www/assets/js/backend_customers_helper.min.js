/* ----------------------------------------------------------------------------
 * Easy!Appointments - Open Source Web Scheduler
 *
 * @package     EasyAppointments
 * @author      A.Tselegidis <alextselegidis@gmail.com>
 * @copyright   Copyright (c) 2013 - 2020, Alex Tselegidis
 * @license     http://opensource.org/licenses/GPL-3.0 - GPLv3
 * @link        http://easyappointments.org
 * @since       v1.0.0
 * ---------------------------------------------------------------------------- */
!function(){"use strict";function e(){this.filterResults={},this.filterLimit=20}e.prototype.bindEventHandlers=function(){var e=this;$("#customers").on("submit","#filter-customers form",(function(t){t.preventDefault();var r=$("#filter-customers .key").val();$("#filter-customers .selected").removeClass("selected"),e.filterLimit=20,e.resetForm(),e.filter(r)})),$("#customers").on("click","#filter-customers .clear",(function(){$("#filter-customers .key").val(""),e.filterLimit=20,e.filter(""),e.resetForm()})),$("#customers").on("click",".customer-row",(function(){if(!$("#filter-customers .filter").prop("disabled")){var t=$(this).attr("data-id"),r=e.filterResults.find((function(e){return Number(e.id)===Number(t)}));e.display(r),$("#filter-customers .selected").removeClass("selected"),$(this).addClass("selected"),$("#edit-customer, #delete-customer").prop("disabled",!1)}})),$("#customers").on("click","#add-customer",(function(){e.resetForm(),$("#add-edit-delete-group").hide(),$("#save-cancel-group").show(),$(".record-details").find("input, select, textarea").prop("disabled",!1),$("#filter-customers button").prop("disabled",!0),$("#filter-customers .results").css("color","#AAA")})),$("#customers").on("click","#edit-customer",(function(){$(".record-details").find("input, select, textarea").prop("disabled",!1),$("#add-edit-delete-group").hide(),$("#save-cancel-group").show(),$("#filter-customers button").prop("disabled",!0),$("#filter-customers .results").css("color","#AAA")})),$("#customers").on("click","#cancel-customer",(function(){var t=$("#customer-id").val();e.resetForm(),t&&e.select(t,!0)})),$("#customers").on("click","#save-customer",(function(){var t={first_name:$("#first-name").val(),last_name:$("#last-name").val(),email:$("#email").val(),phone_number:$("#phone-number").val(),address:$("#address").val(),city:$("#city").val(),zip_code:$("#zip-code").val(),notes:$("#notes").val(),timezone:$("#timezone").val(),language:$("#language").val()||"english"};$("#customer-id").val()&&(t.id=$("#customer-id").val()),e.validate()&&e.save(t)})),$("#customers").on("click","#delete-customer",(function(){var t=$("#customer-id").val(),r=[{text:EALang.cancel,click:function(){$("#message-box").dialog("close")}},{text:EALang.delete,click:function(){e.delete(t),$("#message-box").dialog("close")}}];GeneralFunctions.displayMessageBox(EALang.delete_customer,EALang.delete_record_prompt,r)}))},e.prototype.save=function(e){var t=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_save_customer",r={csrfToken:GlobalVariables.csrfToken,customer:JSON.stringify(e)};$.post(t,r).done(function(e){Backend.displayNotification(EALang.customer_saved),this.resetForm(),$("#filter-customers .key").val(""),this.filter("",e.id,!0)}.bind(this))},e.prototype.delete=function(e){var t=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_delete_customer",r={csrfToken:GlobalVariables.csrfToken,customer_id:e};$.post(t,r).done(function(){Backend.displayNotification(EALang.customer_deleted),this.resetForm(),this.filter($("#filter-customers .key").val())}.bind(this))},e.prototype.validate=function(){$("#form-message").removeClass("alert-danger").hide(),$(".has-error").removeClass("has-error");try{var e=!1;if($(".required").each((function(t,r){""===$(r).val()&&($(r).closest(".form-group").addClass("has-error"),e=!0)})),e)throw new Error(EALang.fields_are_required);if(!GeneralFunctions.validateEmail($("#email").val()))throw $("#email").closest(".form-group").addClass("has-error"),new Error(EALang.invalid_email);return!0}catch(e){return $("#form-message").addClass("alert-danger").text(e.message).show(),!1}},e.prototype.resetForm=function(){$(".record-details").find("input, select, textarea").val("").prop("disabled",!0),$(".record-details #timezone").val("Europe/Madrid"),$("#language").val("catalan"),$("#customer-appointments").empty(),$("#edit-customer, #delete-customer").prop("disabled",!0),$("#add-edit-delete-group").show(),$("#save-cancel-group").hide(),$(".record-details .has-error").removeClass("has-error"),$(".record-details #form-message").hide(),$("#filter-customers button").prop("disabled",!1),$("#filter-customers .selected").removeClass("selected"),$("#filter-customers .results").css("color","")},e.prototype.display=function(e){$("#customer-id").val(e.id),$("#first-name").val(e.first_name),$("#last-name").val(e.last_name),$("#email").val(e.email),$("#phone-number").val(e.phone_number),$("#address").val(e.address),$("#city").val(e.city),$("#zip-code").val(e.zip_code),$("#notes").val(e.notes),$("#timezone").val(e.timezone),$("#language").val(e.language||"english"),$("#customer-appointments").empty(),e.appointments.length||$("<p/>",{text:EALang.no_records_found}).appendTo("#customer-appointments"),e.appointments.forEach((function(e){if(!(GlobalVariables.user.role_slug===Backend.DB_SLUG_PROVIDER&&parseInt(e.id_users_provider)!==GlobalVariables.user.id||GlobalVariables.user.role_slug===Backend.DB_SLUG_SECRETARY&&-1===GlobalVariables.secretaryProviders.indexOf(e.id_users_provider))){var t=GeneralFunctions.formatDate(Date.parse(e.start_datetime),GlobalVariables.dateFormat,!0),r=GeneralFunctions.formatDate(Date.parse(e.end_datetime),GlobalVariables.dateFormat,!0);$("<div/>",{class:"appointment-row","data-id":e.id,html:[$("<a/>",{href:GlobalVariables.baseUrl+"/index.php/backend/index/"+e.hash,html:[$("<i/>",{class:"fas fa-edit mr-1"}),$("<strong/>",{text:e.service.name+" - "+e.provider.first_name+" "+e.provider.last_name}),$("<br/>")]}),$("<small/>",{text:t}),$("<br/>"),$("<small/>",{text:r}),$("<br/>"),$("<small/>",{text:GlobalVariables.timezones[e.provider.timezone]})]}).appendTo("#customer-appointments")}}))},e.prototype.filter=function(e,t,r){r=r||!1;var s=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_filter_customers",a={csrfToken:GlobalVariables.csrfToken,key:e,limit:this.filterLimit};$.post(s,a).done(function(s){this.filterResults=s,$("#filter-customers .results").empty(),s.forEach(function(e){$("#filter-customers .results").append(this.getFilterHtml(e)).append($("<hr/>"))}.bind(this)),s.length?s.length===this.filterLimit&&$("<button/>",{type:"button",class:"btn btn-block btn-outline-secondary load-more text-center",text:EALang.load_more,click:function(){this.filterLimit+=20,this.filter(e,t,r)}.bind(this)}).appendTo("#filter-customers .results"):$("#filter-customers .results").append($("<em/>",{text:EALang.no_records_found})),t&&this.select(t,r)}.bind(this))},e.prototype.getFilterHtml=function(e){var t=e.first_name+" "+e.last_name,r=e.email;return r=e.phone_number?r+", "+e.phone_number:r,$("<div/>",{class:"customer-row entry","data-id":e.id,html:[$("<strong/>",{text:t}),$("<br/>"),$("<span/>",{text:r}),$("<br/>")]})},e.prototype.select=function(e,t){if(t=t||!1,$("#filter-customers .selected").removeClass("selected"),$('#filter-customers .entry[data-id="'+e+'"]').addClass("selected"),t){var r=this.filterResults.find((function(t){return Number(t.id)===Number(e)}));this.display(r),$("#edit-customer, #delete-customer").prop("disabled",!1)}},window.CustomersHelper=e}();
